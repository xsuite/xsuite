\chapter{Xfields}


\section{Fields generated by a bunch of particles}



We assume that the bunch travels rigidly along $s$ with velocity $\beta_0 c$:
\begin{align}
&\rho\left(x, y, s, t\right) = \rho_0\left(x, y, s - \beta_0 ct\right) \label{rhorho0}\\
&\textbf{J}\left(x, y, s, t\right) = \beta_0c\, \rho_0\left(x, y, s - \beta_0 ct\right)  \hat{\textbf{i}}_s \label{JJ0}
\end{align}

We define an auxiliary variable $\zeta$ as the position along the bunch:
\begin{equation}
\zeta = s -\beta_0 c t \, .\label{zetadef}
\end{equation}
We call $K$ the lab reference frame in which we have defined all equations above, and we introduce a boosted frame $K'$ moving rigidly with the reference particle.
The coordinates in the two systems are related by a Lorentz transformation~\cite{jackson}:
\begin{align}
ct' &= \gamma_0 \left(ct -\beta_0 s \right)\label{lorA}\\
x' &= x\label{lorX}\\
y' &= y\label{lorY}\\
s' &= \gamma_0 \left(s -\beta_0 ct \right) = \gamma_0 \zeta\label{lorB}
\end{align}
The  corresponding inverse transformation is:
\begin{align}
ct &= \gamma_0 \left(ct' +\beta_0 s' \right)\label{lorC}\\
x &= x'\label{lorXinv}\\
y &= y'\label{lorYinv}\\
s &= \gamma_0 \left(s' +\beta_0 ct' \right)\label{lorD}
\end{align}



The quantities $\left(c \rho, J_x, J_y, J_s\right)$ form a Lorentz 4-vector and therefore they are transformed between $K$ and $K'$ by relationships similar to the Eqs.~\ref{lorA}-\ref{lorY}~\cite{jackson}:
\begin{align}
c\rho' \left(\textbf{r'}, t'\right)\ &= \gamma_0 \left[c \rho  \left(\textbf{r}\left(\textbf{r'}, t'\right), t\left(\textbf{r'}, t'\right)\right) -\beta_0 J_s \left(\textbf{r}\left(\textbf{r'}, t'\right), t\left(\textbf{r'}, t'\right)\right) \right]\label{lorrho}\\
J_s' \left(\textbf{r'}, t'\right)\ &= \gamma_0 \left[J_s  \left(\textbf{r}\left(\textbf{r'}, t'\right), t\left(\textbf{r'}, t'\right)\right) -\beta_0 c \rho \left(\textbf{r}\left(\textbf{r'}, t'\right), t\left(\textbf{r'}, t'\right)\right) \right]\label{lorjs}
\end{align}
where the transformations $\textbf{r}\left(\textbf{r'}, t'\right)$ and $t\left(\textbf{r'}, t'\right)$ are defined by Eqs.~\ref{lorC} and~\ref{lorD} respectively. The transverse components $J_x$ and $J_y$ of the current vector are invariant for our transformation, and are anyhow zero in our case.

Using Eq.\,\ref{JJ0} these become:
\begin{align}
\rho' \left(\textbf{r'}, t'\right)\ &= \frac{1}{\gamma_0}\rho\left(\textbf{r}\left(\textbf{r'}, t'\right), t\left(\textbf{r'}, t'\right)\right)
\\
J_s' \left(\textbf{r'}, t'\right)\ & = 0
\end{align}

Using Eqs.~\ref{rhorho0} and~\ref{lorC}-\ref{lorYinv}, we obtain:
\begin{equation}
\rho  \left(x', y', s(s', t'), t(s', t')\right) = \rho_0  \left(x', y', s(s', t') - \beta_0 c\,t(s', t')\right)
\end{equation}

From Eq.~\ref{lorB} we get:
\begin{equation}
s(s', t')- \beta_0 c\,t(s', t') = \frac{s'}{\gamma_0} 
\end{equation}
where the coordinate $t' $ has disappeared.

We can therefore write:
\begin{equation}
\rho' \left(x', y', s', t'\right) =   \frac{1}{\gamma_0} \rho_0  \left(x', y',  \frac{s'}{\gamma_0}\right)\label{rhoprimerho0}
\end{equation}

The electric potential in the bunch frame is solution of Poisson's equation:

\begin{equation}
\frac{\partial^2 \phi'}{\partial x'^2} +  \frac{\partial^2 \phi'}{\partial y'^2}+  \frac{\partial^2 \phi'}{\partial s'^2}= -\frac{\rho' (x', y', s')}{\varepsilon_0}
\end{equation}

From Eq.~\ref{rhoprimerho0} we can write:
\begin{equation}
\frac{\partial^2 \phi'}{\partial x'^2} +  \frac{\partial^2 \phi'}{\partial y'^2}+  \frac{\partial^2 \phi'}{\partial s'^2}= -\frac{1}{\gamma_0\varepsilon_0}  \rho_0 \left(x', y', \frac{s'}{\gamma_0}\right)\label{poissrho0}
\end{equation}

We now make the substitution:
\begin{equation}
\zeta = \frac{s'}{\gamma_0} \label{subst}
\end{equation}
obtained from Eq.~\ref{lorB}, which allows to rewrite Eq.~\ref{poissrho0} as:
\begin{equation}
\frac{\partial^2 \phi'}{\partial x^2} +  \frac{\partial^2 \phi'}{\partial y^2}+  \frac{1}{\gamma_0^2}\frac{\partial^2 \phi'}{\partial \zeta^2}=  -\frac{1}{\gamma_0\varepsilon_0}{\rho}_0 \left(x, y,\zeta\right) \label{modifpoiss}
\end{equation}
Here we have dropped the ``$'$'' sign from $x$ and $y$ as these coordinates are unaffected by the Lorentz boost.




The quantities $\left( \frac{\phi}{c}, A_x, A_y, A_s\right)$ form a Lorentz 4-vector, so we can write:
\begin{align}
\phi &= \gamma_0 \left( {\phi'} +  \beta_0 c A'_s\right)\\
A_s &= A'_s +\beta_0 \frac{\phi'}{c}
\end{align}
In the bunch frame the charges are at rest therefore $A'_x=A'_y=A'_s=0$ therefore:
\begin{align}
\phi &= \gamma_0 \phi'\label{phiphip}\\
A_s &= \beta_0 \frac{\phi'}{c} =  \frac{\beta_0}{\gamma_0c}\phi
\end{align}

Combining Eq.\,\ref{phiphip} with Eq.\,\ref{modifpoiss} we obtain the equation in $\phi$:
\begin{equation}
\boxed{
\frac{\partial^2 \phi}{\partial x^2} +  \frac{\partial^2 \phi}{\partial y^2}+  \frac{1}{\gamma_0^2}\frac{\partial^2 \phi}{\partial \zeta^2}=  -\frac{1}{\varepsilon_0}{\rho}_0 \left(x, y,\zeta\right)} \label{modifpoiss_zeta}
\end{equation}

\subsection{2.5D approximation}
For large enough values of $\gamma_0$, Eq.~\ref{modifpoiss} can be approximated by:
\begin{equation}
\boxed{
\frac{\partial^2 \phi}{\partial x^2} +  \frac{\partial^2 \phi}{\partial y^2} = -\frac{1}{\varepsilon_0}{\rho}_0 \left(x, y,\zeta\right) }\label{2dpoiss}
\end{equation}
which means that we can solve a simple 2D problem for each beam slice (identified by its coordinate $\zeta$).


\subsection{Modulated 2D}
\label{sec:modulated2d}

Often the beam distribution can be factorized as:
\begin{equation}
\rho_0(x,y,\zeta) = q_0\lambda_0(\zeta)\rho_\perp(x,y) 
\end{equation}
where:
\begin{equation}
\int \rho_\perp(x,y) \,dx\,dy = 1
\end{equation}
and $\lambda_0(z)$ is therefore the bunch line density.

For a bunched beam:
\begin{equation}
\int \lambda_0(z) \,dz = N \label{eq:lamnorm}\\
\end{equation}
where $N$ is the bunch population.

In this case the potential can be factorized as:
\begin{equation}
\phi(x,y,\zeta) = q_0\lambda(\zeta)\phi_\perp(x,y) 
\label{eq:factorized2d}
\end{equation}

where $\phi_\perp(x,y)$ is the solution of the following 2D Poisson equation:
\begin{equation}
\frac{\partial^2 \phi_\perp}{\partial x^2} +  \frac{\partial^2 \phi_\perp}{\partial y^2} = -\frac{1}{\varepsilon_0}{\rho}_\perp \left(x, y\right) \label{2dpoisspeerp}
\end{equation}


%\section{Interaction time}
%In the lab frame the particle moves with speed $\beta$:
%\begin{equation}
%s(t) = \zeta_p +\beta c t
%\end{equation}
%
%In the frame $K'$, the kinematic equation of the particle can be obtained by replacing Eqs.~\ref{lorC} and~\ref{lorD} into Eq.~\ref{st_tau}:
%\begin{equation}
%\gamma_0 \left(s' +\beta_0 ct' \right) = \zeta_p +\beta \gamma_0 \left(ct' +\beta_0 s' \right)
%\end{equation}
%
%Solving for $s'$ we obtain:
%\begin{equation}
%s' = -\beta \gamma c \tau = \gamma \zeta\label{sprimezeta}
%\end{equation}
%Of course for the reference particle we obtain $s' = 0$.
%We observe that \textbf{beam particles are at rest in the reference frame $K'$ and that the distance between them is increased by a factor $\gamma$ with respect to the lab frame $K$}.

%\section{Transverse kick on the beam particle}
%
%We now evaluate the change on the transverse momentum for a beam particle defined in the lab frame by its transverse coordinates $x$ and $y$ and by its delay $\tau$ with respect to the reference particle (or equivalently by its $\zeta$ coordinate, defined by Eq.~\ref{zetadef}).
%
%We have seen that in the frame $K'$ the particle is at rest and has longitudinal coordinate $s' = \gamma \zeta$ (see Eq.~\ref{sprimezeta}). 
%The x' component of the electric field $\textbf{E}'$ acting on P is given by (see Eqs.~\ref{potential} and~\ref{phiphiprime}):
%\begin{equation}
%E'_x = -\frac{\partial \phi'}{\partial x} = -\frac{1}{\gamma_0}\frac{\partial \phi}{\partial x} \label{Exprime}
%\end{equation}
%Again, we have dropped the ``$'$'' sign from $x$ and $y$ as these coordinates are unaffected by the Lorentz boost.
%
%
%The change in the x component of the momentum, which is an invariant for our Lorentz transformation, is given by :
%\begin{equation}
%\Delta P_x = \Delta P'_x = qE'_x T'
%\end{equation}
%
%Using Eqs.~\ref{Exprime} and~\ref{Tprime} we can write:
%\begin{equation}
%\Delta P_x = -\frac{qL}{\beta c} \frac{\partial \phi}{\partial x}\left(x, y,\zeta\right)
%\end{equation}
%
%Normalizing to the momentum of the reference particle:
%
%\begin{equation}
%\Delta p_x = \frac{\Delta P_x} {P}= -\frac{qL}{ m\gamma\beta^2 c^2} \frac{\partial \phi}{\partial x}\left(x, y,\zeta\right)\label{dpx}
%\end{equation}
%
%Similarly, for the $y$-direction we can write: 
%\begin{equation}
%\Delta p_y = \frac{\Delta P_y} {P}= -\frac{qL}{ m\gamma\beta^2 c^2} \frac{\partial \phi}{\partial y}\left(x, y,\zeta\right)\label{dpy}
%\end{equation}

\section{Lorentz force}
We now compute the Lorentz force on the particles moving in the longitudinal directions, including particles of the bunch itself (space charge forces) and particles of a colliding bunch moving in the opposite directions (beam-beam forces).
The angles of such test particles are neglected as done in the usual thin-lens approximation. Therefore the velocity of a test particle can be written as:
\begin{equation}
\textbf{v} = \beta c\, \hat{\textbf{i}}_s
\end{equation}

The Lorenz force can be written as:
\begin{equation}
\begin{split}
\textbf{F} &=q \left( -\nabla \phi -\frac{\partial \textbf{A}}{\partial t}
 + \beta c \ \hat{\textbf{i}}_s \times {\left(\nabla \times \textbf{A} \right)} \right)\\
 &=q \left( -\nabla \phi -\frac{\beta_0}{\gamma_0 c}\frac{\partial \phi}{\partial t}\hat{\textbf{i}}_s
 + \beta c \ \hat{\textbf{i}}_s \times {\left(\nabla \times \textbf{A} \right)} \right)
 \end{split}
\end{equation}

We compute the vector product:
\begin{align}
\begin{split}
\hat{\textbf{i}}_s \times \left(\nabla \times \textbf{A}\right) &= \left(\frac{\partial A_s}{\partial x} - \frac{\partial A_x}{\partial s} \right) \hat{\textbf{i}}_x + \left(\frac{\partial A_s}{\partial y} - \frac{\partial A_y}{\partial s} \right) \hat{\textbf{i}}_y\\
 &= \left(\frac{\partial A_s}{\partial x} - \frac{\partial A_x}{\partial s} \right) \hat{\textbf{i}}_x + \left(\frac{\partial A_s}{\partial y} - \frac{\partial A_y}{\partial s} \right) \hat{\textbf{i}}_y + \underbrace{\left(\frac{\partial A_s}{\partial s} - \frac{\partial A_s}{\partial s} \right)}_{=0} \hat{\textbf{i}}_s\\
 &= \nabla A_s - \frac{\partial \textbf{A}}{\partial s} 
\end{split} 
\end{align}

We replace:
\begin{equation}
\textbf{F} 
=q \left( -\nabla \phi -\frac{\beta_0}{\gamma_0 c}\frac{\partial \phi}{\partial t}\hat{\textbf{i}}_s
 + \beta  \beta_0\nabla \phi - \frac{\beta \beta_0}{\gamma_0} \frac{\partial \phi}{\partial s} \hat{\textbf{i}}_s
  \right)
\end{equation}

The potentials will have the same form as the sources (this can be shown explicitly using the Lorentz transformations):
\begin{equation}
\phi(x, y, s, t) = \phi\left(x, y, t - \frac{s}{\beta_0 c}\right)
\end{equation}
For a function in this form we can write:
\begin{equation}
 \frac{\partial \phi}{\partial s} = 
\frac{\partial}{\partial\zeta} 
 = -\frac{1}{\beta_0 c}\frac{\partial \phi}{\partial t} \label{derder}
\end{equation}


obtaining:
\begin{equation}
\textbf{F} 
=q \left( -\nabla \phi +\frac{\beta_0^2}{\gamma_0}\frac{\partial \phi}{\partial \zeta}\hat{\textbf{i}}_s
 + \beta  \beta_0\nabla \phi - \frac{\beta \beta_0}{\gamma_0} \frac{\partial \phi}{\partial \zeta} \hat{\textbf{i}}_s
  \right)
\end{equation}


Reorganizing:
\begin{equation}
\textbf{F} 
=  -q(1-\beta  \beta_0)\nabla \phi -\frac{\beta_0(\beta-\beta_0)}{\gamma_0}\frac{\partial \phi}{\partial \zeta}\hat{\textbf{i}}_s
\end{equation}

Writing the dependencies explicitly:
\begin{align}
F_x(x, y, \zeta(t)) &=  -q(1-\beta  \beta_0) \frac{\partial \phi}{\partial x}(x, y, \zeta(t))\label{eq:forcex}\\
F_y(x, y, \zeta(t)) &=  -q(1-\beta  \beta_0) \frac{\partial \phi}{\partial y}(x, y, \zeta(t))\label{eq:forcey}\\
F_z(x, y, \zeta(t)) &=  -q\left(1-\beta  \beta_0 -\frac{\beta_0(\beta-\beta_0)}{\gamma_0}\right) \frac{\partial \phi}{\partial \zeta}(x, y, \zeta(t))\label{eq:forcez}
\end{align}
where $\zeta(t)$ is the position of the particle within the bunch.


\section{Space charge}

Over the single interaction we neglect the particle slippage\footnote{In any case one would need to take into account also the dispersion in order to have the right slippage.}:
\begin{align}
&\beta = \beta_0\\
&\zeta(t) = \zeta
\end{align}

This gives the following simplification of Eqs.\,\eqref{eq:forcex}\,-\,\eqref{eq:forcez}:
\begin{align}
F_x(x, y, \zeta) &=  -q(1-\beta_0^2) \frac{\partial \phi}{\partial x}(x, y, \zeta)\\
F_y(x, y, \zeta) &=  -q(1-\beta_0^2) \frac{\partial \phi}{\partial y}(x, y, \zeta)\\
F_z(x, y, \zeta) &=  -q (1-\beta_0^2) \frac{\partial \phi}{\partial \zeta}(x, y, \zeta)
\end{align}

In this way the force over the single interaction becomes independent on time and therefore we can compute the kicks simply as:
\begin{equation}
\Delta \textbf{P} = \frac{L}{\beta_0 c}\textbf{F} 
\end{equation}
where $L$ is the portion of the machine on which we want to compute the e-cloud interaction.

The kicks on the normalized momenta can be expressed as (recalling that $P_0=m_0\beta_0\gamma_0c$):

\begin{align}
&\boxed{
\Delta p_x = \frac{m_0}{m}\frac{\Delta P_x} {P_0}= -\frac{qL (1-\beta_0^2)}{ m\gamma_0\beta_0^2 c^2} \frac{\partial \phi}{\partial x}\left(x, y,\zeta\right)}\label{dpx}\\
&\boxed{
\Delta p_y = \frac{m_0}{m}\frac{\Delta P_y} {P_0}= -\frac{qL (1-\beta_0^2)}{ m\gamma_0\beta_0^2 c^2} \frac{\partial \phi}{\partial y}\left(x, y,\zeta\right)}\label{dpy}\\
&\boxed{
\Delta \delta \simeq \Delta p_z = \frac{m_0}{m}\frac{\Delta P_z} {P_0}= -\frac{qL (1-\beta_0^2)}{ m\gamma_0\beta_0^2 c^2} \frac{\partial \phi}{\partial \zeta}\left(x, y,\zeta\right)}
\label{dpz}
\end{align}

If the beam includes particles of different species (tracking of fragments), note that here $q$ and $m$ refer to the individual particle while $m_0$ is the mass of the reference particle.



In the modulated 2D case (see Sec.\,\ref{sec:modulated2d} and in particular Eq.\,\ref{eq:factorized2d}), the kick can be expressed as:
\begin{align}
&\boxed{
\Delta p_x = \frac{m_0}{m}\frac{\Delta P_x} {P_0}= -\frac{qq_0L (1-\beta_0^2)}{ m\gamma_0\beta_0^2 c^2} \,\lambda_0(\zeta)\,\frac{\partial {\phi_\perp}}{\partial x}\left(x, y\right)}\label{dpx_mod}\\
&\boxed{
\Delta p_y = \frac{m_0}{m}\frac{\Delta P_y} {P_0}= -\frac{qq_0L (1-\beta_0^2)}{ m\gamma_0\beta_0^2 c^2} \,\lambda_0(\zeta)\, \frac{\partial{\phi_\perp}}{\partial y}\left(x, y\right)}\label{dpy_mod}\\
&\boxed{
\Delta \delta \simeq \Delta p_z = \frac{ m_0} {m}\frac{\Delta P_z} {P_0}= -\frac{qq_0L (1-\beta_0^2)}{ m\gamma_0\beta_0^2 c^2} \,\frac{d\lambda_0}{d\zeta}(\zeta)\,{\phi_\perp}\left(x, y\right)}\label{dpz_mod}
\end{align}

\section{Beam-beam interaction (4D model)}

We consider a test particle moving in the opposite direction with velocity:
\begin{align}
\textbf{v}_W = -\beta_{0W} c\, \hat{\textbf{i}}_s\\
s_W(t) = -\beta_{0W} ct
\end{align}
Equations\,\eqref{eq:forcex}\,-\,\eqref{eq:forcez} become:
\begin{align}
F_x(x, y, \zeta_W(t)) &=  -q(1+\beta_{0W}  \beta_{0s}) \frac{\partial \phi}{\partial x}(x, y, \zeta_W(t)) \label{eq:bbfgenx}\\
F_y(x, y, \zeta_W(t)) &=  -q(1+\beta_{0W}  \beta_{0S}) \frac{\partial \phi}{\partial y}(x, y, \zeta_W(t))\label{eq:bbfgeny}\\
F_z(x, y, \zeta_W(t)) &=  -q\left(1+\beta_{0W}  \beta_{0S} -\frac{\beta_{0S}(\beta_{0W}+\beta_{0S})}{\gamma_0}\right) \frac{\partial \phi}{\partial \zeta}(x, y, \zeta_W(t))\label{eq:bbfgenz}
\end{align}
where we have used the the subscript $S$ (strong) for the bunch generating the fields, and the subscript $W$ (weak) for the test particle. 

$\zeta_W(t)$ is the position of the test particle within the bunch generating the fields: 
\begin{equation}
\zeta_W(t)= s_W(t) -\beta_{0S} c t  = -(\beta_{0W}+\beta_{0S})ct
\label{eq:zetaw}
\end{equation}

In modulated-2D case (Eq.\,\ref{eq:factorized2d}), Eqs.\,\eqref{eq:bbfgenx}\,-\,\eqref{eq:bbfgeny} become:
\begin{align}
F_x(x, y, \zeta_W(t)) &=  -q q_{0S} (1+\beta_{0W}  \beta_{0s})
\lambda_{0S}(\zeta_W(t))
 \frac{\partial \phi_\perp}{\partial x}(x, y ) \\
F_y(x, y, \zeta_W(t)) &=  -qq_{0S}  (1+\beta_{0W}  \beta_{0s})
\lambda_{0S}(\zeta_W(t))
 \frac{\partial \phi_\perp}{\partial y}(x, y ) \\
F_z(x, y, \zeta_W(t)) &=  -qq_{0S}\left(1+\beta_{0W}  \beta_{0S} -\frac{\beta_{0S}(\beta_{0W}+\beta_{0S})}{\gamma_0}\right) \frac{d \lambda_{0S}}{d \zeta}(\zeta_W(t)) \phi_\perp(x, y)
\end{align}

The change in momentum for the test particle is given by:
\begin{equation}
\Delta \textbf{P} = \int_{-\infty}^{+\infty} \textbf{F}(t) \,dt
\end{equation}
Therefore:
\begin{align}
\Delta P_x(x, y, \zeta_W(t)) &=  -qq_{0S} N_S (1+\beta_{0W}  \beta_{0s})
\frac{\partial \phi_\perp}{\partial x}(x, y ) \int_{-\infty}^{+\infty}\lambda_{0S}(\zeta_W(t)) \,dt\\
\Delta P_y(x, y, \zeta_W(t)) &=  -qq_{0S} N_S (1+\beta_{0W}  \beta_{0s})
 \frac{\partial \phi_\perp}{\partial y}(x, y ) \int_{-\infty}^{+\infty}\lambda_{0S}(\zeta_W(t)) \,dt\\
\Delta P_z(x, y, \zeta_W(t)) &=  -qq_{0S}\left(1+\beta_{0W}  \beta_{0S} -\frac{\beta_{0S}(\beta_{0W}+\beta_{0S})}{\gamma_0}\right) \phi_\perp(x, y) \int_{-\infty}^{+\infty}\frac{d \lambda_{0S}}{d \zeta}(\zeta_W(t)) \, dt
\end{align}

Using Eq.\,\eqref{eq:zetaw} and Eq.\,\eqref{eq:lamnorm} we can write:
\begin{equation}
\int_{-\infty}^{+\infty}\lambda_{0S}(\zeta_W(t)) \,dt 
=\frac{1}{(\beta_{0W}+\beta_{0S})c}\int_{-\infty}^{+\infty}\lambda_{0S}(\zeta) \,d\zeta = \frac{N_S}{(\beta_{0W}+\beta_{0S})c}
\end{equation}

Similarly, for a bunched beam:
\begin{equation}
\int_{-\infty}^{+\infty}
\frac{d \lambda_{0S}}{d \zeta}(\zeta_W(t)) \,dt 
=\frac{1}{(\beta_{0W}+\beta_{0S})c}\int_{-\infty}^{+\infty}\frac{d \lambda_{0S}}{d \zeta} \,d\zeta = \frac{ \lambda_{0S}(+\infty)-\lambda_{0S}(-\infty)}{(\beta_{0W}+\beta_{0S})c} = 0
\end{equation}

From which we can write:
\begin{align}
&\boxed{
\Delta p_x = \frac{m_0}{m}\frac{\Delta P_x} {P_0}= -\frac{qq_{0S} N_S 
}{m\beta_{0W}\gamma_{0W}c^2}
\frac{(1+\beta_{0W}  \beta_{0s})}{(\beta_{0W}+\beta_{0S})}
\frac{\partial \phi_\perp}{\partial x}(x, y )}\\
&\boxed{
\Delta p_y = \frac{m_0}{m}\frac{\Delta P_y} {P_0}= -\frac{qq_{0S} N_S 
}{m\beta_{0W}\gamma_{0W}c^2}
\frac{(1+\beta_{0W}  \beta_{0s})}{(\beta_{0W}+\beta_{0S})}
\frac{\partial \phi_\perp}{\partial y}(x, y )}\\
&\boxed{
\Delta p_z = \frac{m_0}{m}\frac{\Delta P_z} {P_0}=0}
\end{align}

\section{Longitudinal profiles}
\subsection{Gaussian profile}

The profile is in the form:
\begin{equation}
\lambda_{0}(z)=\frac{N}{\sqrt{2 \pi} \sigma} e^{-\frac{(z-z_0)^{2}}{2 \sigma^{2}}}
\end{equation}


\subsection{q-Gaussian}

The profile is in the form:
\begin{equation}
\lambda_0(z)=\frac{N\sqrt{\beta}}{C_{q}} e_{q}\left(-\beta (z-z_0)^{2}\right)
\end{equation}
where $e_q$ is the q-exponential function:
\begin{equation}
e_{q}(x)=[1+(1-q) x]_{+}^{\frac{1}{1-q}}
\end{equation}
$C_q$ is a normalization factor dependent on $q$ alone:
\begin{equation}
C_{q}=\frac{\sqrt{\pi} \Gamma\left(\frac{3-q}{2(q-1)}\right)}{\sqrt{q-1} \Gamma\left(\frac{1}{q-1}\right)}
\end{equation}

The parameter beta defines the standard deviation of the distribution:

\begin{equation}
\sigma = \sqrt{\frac{1}{\beta(5-3 q)}} \iff \beta ={\frac{1}{\sigma^2(5-3 q)}}
\end{equation}



These expressions are valid for values of the parameter $q$ is   the range of interest:
\begin{equation}
1<q<\frac{5}{3}
\end{equation}

In general the q-Gaussian is defined outside this range, but for smaller values it has a limited support (not of interest) and for larger values has a not defined standard deviation.



\section{FFT Poisson solver}

\subsection{Notation for Discrete Fourier Transform}
We will use the following notation for the Discrete Fourier Transform of a sequence of length $M$:
\begin{equation}
\hat{a}_k = \text{DFT}_M(a_m) =  \sum_{m=0}^{M-1} a_m\, e^{-j2\pi  \frac{km}{M}}  \quad \text{for } k \in 0, ..., M
\end{equation}
The corresponding inverse transform is defined as:
\begin{equation}
{a}_n = \text{DFT}^{-1}_M(\hat{a}_k) =  \frac{1}{M}\sum_{k=0}^{M-1} \hat{a}_k\, e^{j2\pi  \frac{km}{M}}  \quad \text{for } m \in 0, ..., M
\end{equation}

Multidimensional Discrete Fourier Transforms are obtained by applying sequentially 1D DFTs.. For example, in two dimensions:

\begin{equation}
\begin{split}
\hat{a}_{k_xk_y} &= \text{DFT}_{M_xM_y}\left\{a_{m_xm_y}\right\}  
= \text{DFT}_{M_y} \left\{\text{DFT}_{M_x}\left\{a_{m_xm_y}\right\}\right\}\\  
&=\sum_{m_x=0}^{M_x-1} e^{-j 2\pi  \frac{k_x m_x}{M_x}} 
\sum_{m_y=0}^{M_y-1} e^{-j 2\pi  \frac{k_y m_y}{M_y}} a_{m_xm_y}
\end{split}
\end{equation}
\begin{equation}
\begin{split}
{a}_{n_xn_y} &= \text{DFT}^{-1}_{M_xM_y}\left\{a_{k_x k_y}\right\}  
= \text{DFT}^{-1}_{M_y} \left\{\text{DFT}^{-1}_{M_x}\left\{\hat{a}_{k_x k_y}\right\}\right\}\\  
&=\frac{1}{M_x M_y}\sum_{k_x=0}^{M_x-1} e^{j 2\pi  \frac{k_x m_x}{M_x}} 
\sum_{k_y=0}^{M_y-1} e^{j 2\pi  \frac{k_y m_y}{M_y}} \hat{a}_{k_xk_y}
\end{split}
\end{equation}

\subsection{FFT convolution - 1D case}
The potential can be written as the convolution of a Green function with the charge distribution:
\begin{equation}
\phi(x) = \int_{-\infty}^{+\infty} \rho(x')\,G(x-x') dx'
\label{eq:conv}
\end{equation}

We assume that the source is limited to the region  $[a, b]$:
\begin{equation}
\rho(x) = \rho(x)\,\Pi_{[a,b]}\left(x\right)
\label{eq:rholim}
\end{equation}
where $\Pi_{[a,b]}(x)$ is a rectangular window function defined as:
\begin{equation}
\Pi_{[a,b]}(x) = 
\begin{cases}
1\quad\text{for } x \in [a, b]\\
0\quad\text{elsewhere}
\end{cases}
\end{equation}

We are interested in the electric potential in a given region $[c, d]$, so we can compute:
\begin{equation}
\phi_{cd}(x) = \phi(x) \Pi_{[c, d]}\left(x\right)
\label{eq:philim}
\end{equation}

We replace Eq.\,\eqref{eq:rholim} and Eq.\,\eqref{eq:philim} into Eq.\eqref{eq:conv}, obtaining:
\begin{equation}
\phi_{cd}(x) = \Pi_{[c,d]}\left( x\right)
\int_{-\infty}^{+\infty} 
\Pi_{[a,b]}\left(x'\right)
\rho(x')\,G(x-x') dx'
\end{equation}
We apply the change of variable $x'' = x - x'$:
\begin{equation}
\phi_{cd}(x) = 
\int_{-\infty}^{+\infty} 
\Pi_{[c,d]}\left({x}\right)
\Pi_{[a,b]}\left({x-x''}\right)
\rho(x-x'')\,G(x'') \,dx''
\label{eq:conv1}
\end{equation}
The integrand vanishes outside the set of the $(x, x'')$ defined by the two window functions:
\begin{equation}
\begin{cases}
c < x <d\\
a < (x-x'') <b
\end{cases}
\end{equation}

We flip the signs in the second equation, obtaining:
\begin{equation}
\begin{cases}
c < x < d\\
-b < (x''-x) <-a
\end{cases}
\end{equation}

Combining the two equations we obtain:
\begin{equation}
c-b<-b + x < x'' <-a+x<d-a
\end{equation}
i.e. the integrand is not zero for $c-b< x'' <d-a$.
Therefore in Eq.\,\eqref{eq:conv1} we can replace $G(x'')$ with its truncated version:
\begin{equation}
G_\text{tr}(x'') = G(x'')\,\Pi_{[c-b,~d-a]}
\left(
{x''}
\right)
\end{equation}

obtaining:
\begin{equation}
\phi_{cd}(x) = 
\int_{-\infty}^{+\infty} 
\Pi_{[c,d]}\left({x}\right)
\Pi_{[a,b]}\left({x-x''}\right)
\rho(x-x'')\,G_\text{tr}(x'') dx''
\label{eq:conv2}
\end{equation}


We can go back to the initial coordinate by substituting $x'' = x-x'$:
\begin{equation}
\phi_{cd}(x) = 
\Pi_{[c,d]}\left({x}\right)
\int_{-\infty}^{+\infty} 
\rho(x')\,G_\text{tr}(x-x') dx'
\end{equation}


We call:
\begin{align}
L_1 = b - a\\
L_2 = d - c 
\end{align}

The measure of the set on which $G_\text{tr}(x'')$ is non zero is 

\begin{equation}
(d-a) - (c - b) = L_1+ L_2
\end{equation}

We define $L$ such that:
\begin{equation}
L_1+ L_2 = 2L
\end{equation}

Since the two window functions in Eq.\,\ref{eq:conv2} force the integrand to zero outside the region $c-b< x'' <d-a$ of measure $2L$, we can replace $G_\text{tr}(x'')$ with its replicated version:
\begin{equation}
G_{R}(x'') = \sum_{n=-\infty}^{+\infty}G_\text{tr}(x''-2nL) = \sum_{n=-\infty}^{+\infty}G(x'' -2nL)\,\Pi_{[c-b,~d-a]}
\left(
{x''-2nL}
\right)
\label{eq:GLR}
\end{equation}
obtaining:
\begin{equation}
\phi_{cd}(x) = 
\int_{-\infty}^{+\infty} 
\Pi_{[c,d]}\left({x}\right)
\Pi_{[a,b]}\left({x-x''}\right)
\rho(x-x'')\,G_{R}(x'') dx''
\end{equation}

We can go back to the initial coordinate by substituting $x'' = x-x'$:
\begin{equation}
\phi_{cd}(x) = 
\Pi_{[c,d]}\left({x}\right)
\int_{-\infty}^{+\infty} 
\rho(x')\,G_{R}(x-x') dx'
\end{equation}

This is a cyclic convolution, so we can proceed as follows. We split the integral:
\begin{equation}
\phi_{cd}(x) = 
\Pi_{[c,d]}\left({x}\right)
\sum_{n=-\infty}^{+\infty}
\int_{2nL}^{2(n+1)L} 
\rho(x')\,G_{R}(x-x') \,dx'
\label{eq:conv3}
\end{equation}
In each term we replace $x''' = x'+2nL$:
\begin{equation}
\phi_{cd}(x) = 
\Pi_{[c,d]}\left({x}\right)
\sum_{n=-\infty}^{+\infty}
\int_{0 }^{2L} 
\rho(x'''-2nL)\,G_{R}(x-x'''-2nL) \,dx'''
\label{eq:conv4}
\end{equation}
We use the fact that $G_{R}(x)$ is periodic:
\begin{equation}
\begin{split}
\phi_{cd}(x) &= 
\Pi_{[c,d]}\left({x}\right)
\sum_{n=-\infty}^{+\infty}
\int_{0 }^{2L} 
\rho(x'''-2nL)\,G_{R}(x-x''') dx'''\\
\\&=
\Pi_{[c,d]}\left({x}\right)
\int_{0 }^{2L}  
G_{R}(x-x''')
\sum_{n=-\infty}^{+\infty}
\rho(x'''-2nL) 
\, dx'''
\end{split}
\label{eq:conv5}
\end{equation}

We can define a replicated version of $\rho(x)$:
\begin{equation}
\rho_{R}(x)= \sum_{n=-\infty}^{+\infty}
\rho(x-2nL)
\end{equation}

%noting that this implies:
%\begin{equation}
%\rho_{2LR}(x)= 0 \quad \text{for } x \in [L, 2L]
%\label{eq:zeros}
%\end{equation}

We obtain:
\begin{equation}
\phi_{cd}(x) = 
\Pi_{[c,d]}\left({x}\right)
\int_{0 }^{2L} 
\rho_{R}(x')\,G_{R}(x-x') dx'
\label{eq:conv6}
\end{equation}

The function:

\begin{equation}
\phi_{R}(x) = 
\int_{0 }^{2L} 
\rho_{R}(x')\,G_{R}(x-x') dx'
\label{eq:confin}
\end{equation}
is periodic of period $2L$. From it the potential of interest can be simply calculated by selecting the right interval $[c, d]$:
\begin{equation}
\phi_{cd}(x) = 
\Pi_{[c,d]}\left({x}\right)
\phi_{R}(x)
\label{eq:sel}
\end{equation}

To compute the convolution in Eq.\,\ref{eq:confin} we expand $\phi_{R}(x)$ in a Fourier series starting from $x=c$:
\begin{equation}
\phi_{R}(x) = \sum_{k=-\infty}^{+\infty} \tilde{\phi}_k\, e^{j2\pi k \frac{x}{2L}}
\label{eq:phifour}
\end{equation}
where the Fourier coefficients are given by:
\begin{equation}
\tilde{\phi}_k = \frac{1}{2L}\int_0^{2L} \phi_{R}(x)\, e^{-j2\pi k \frac{x}{2L}} \, dx
\label{eq:phik}
\end{equation}

We replace Eq.\,\eqref{eq:confin} into Eq.\,\eqref{eq:phik} obtaining:
\begin{equation}
\tilde{\phi}_k = \frac{1}{2L}\int_0^{2L} \int_{0 }^{2L} 
\rho_{R}(x')\,G_{R}(x-x') \, e^{-j2\pi k \frac{x}{2L}} \,  dx'\, dx
\end{equation}

With the change of variable $x'' = x-x'$ we obtain:
\begin{equation}
\tilde{\phi}_k = 
\frac{1}{2L}
\int_0^{2L} 
\rho_{R}(x') e^{-j2\pi k \frac{x'}{2L}}dx'\,
\int_{0 }^{2L} 
\,G_{R}(x'') e^{-j2\pi k \frac{x''}{2L}}\,  \,  dx''
\end{equation}

where we recognize the Fourier coefficients of $\rho_{R}(x)$ and $\,G_{R}(x)$:
\begin{align}
\tilde{\rho}_k = \frac{1}{2L}\int_0^{2L} \rho_{R}(x)\, e^{-j2\pi k \frac{x}{2L}} \, dx \label{eq:rhok}\\
\tilde{G}_k = \frac{1}{2L}\int_0^{2L} G_{R}(x)\, e^{-j2\pi k \frac{x}{2L}} \, dx \label{eq:Gk}
\end{align}
obtaining simply:
\begin{equation}
\tilde{\phi}_k = 2L \, \tilde{G}_k \, \tilde{\rho}_k
\label{eq:freqconv}
\end{equation}

We assume to have the functions $\rho_{R}(x)$ and  $G_{R}(x)$ sampled (or averaged) with step:
\begin{equation}
h_x = \frac{2L}{M}
\end{equation}

We assume that all intervals have size multiple of $h_x$. So we can define:
\begin{align}
N_1 &= L_1 / h_x\\
N_2 &= L_2 / h_x
\end{align}

We call:
\begin{align}
 \rho_{Rn} &= \rho_{R}\left(a + nh_x\right)\\
 \phi_{Rn} &= \phi_{R}\left(c + nh_x\right)\\
 G_{Rn} &= G_{R}\left(c - b + nh_x\right)
\end{align}

By construction:
\begin{equation}
 \rho_{Rn} \equiv \rho_n = 
 \begin{cases}
\rho\left(a + nh_x\right)&\text{for}~0 \leq n <N_1 \\
 0 & \text{for}~N_1 \leq n < M
 \end{cases}
\end{equation}

\begin{equation}
G_{Rn} \equiv  G_n = G\left(c - b + nh_x\right)
\text{ for}~0 \leq n <M
\end{equation}

We can approximate the integral as follows

\begin{align}
\tilde{\rho}_k &= \frac{1}{2L}\int_0^{2L} \rho_{R}(x)\, e^{-j2\pi k \frac{x}{2L}} \, dx = \frac{1}{2L}\int_a^{a+2L} \rho_{R}(x)\, e^{-j2\pi k \frac{x}{2L}} \, dx\\
&\simeq 
\frac{h_x}{2L}\sum_{n=0}^{M-1} \rho_{R}(a+nh_x)\, e^{-j2\pi k \frac{a+nh_x}{2L}} 
=
e^{-j2\pi k \frac{a}{2L}} \frac{1}{M}
\sum_{n=0}^{M-1}
 \rho_{Rn} e^{-j2\pi \frac{kn}{M}} 
\end{align}

We recognize the Discrete Fourier Transform:

\begin{equation}
\tilde{\rho}_k 
=
e^{-j2\pi k \frac{a}{2L}} \frac{1}{M}
\text{DFT}_M\left\{ \rho_{Rn}\right\}
=
e^{-j2\pi k \frac{a}{2L}} \frac{1}{M}
\hat{\rho}_k 
\end{equation}
and similarly we can obtain
\begin{equation}
\tilde{\phi}_k 
=
e^{-j2\pi k \frac{c}{2L}} \frac{1}{M}
\text{DFT}_M\left\{ \phi_{Rn}\right\}
=
e^{-j2\pi k \frac{c}{2L}} \frac{1}{M}
\hat{\phi}_k 
\end{equation}

\begin{equation}
\tilde{G}_k 
=
e^{-j2\pi k \frac{c-b}{2L}} \frac{1}{M}
\text{DFT}_M\left\{ G_{Rn}\right\}
=
e^{-j2\pi k \frac{c-b}{2L}} \frac{1}{M}
\hat{G}_k 
\end{equation}


Replacing in Eq. \ref{eq:freqconv} we obtain

\begin{equation}
\hat{\phi}_k  = 
h_x e^{-j2\pi k \frac{a-b}{2L}} 
\hat{\rho}_k \hat{G}_k
\end{equation}





\clearpage


\subsection{FFT convolution compressed}

We assume that the source has the form
\begin{equation}
\rho(x) =  \sum_j \rho^\text{loc}_j(x - jP)
\label{eq:rholim_period}
\end{equation}
where $\rho^\text{loc}_j(x)$ is limited to the interval $[a, b]$.

We are interested in the potential in a set of intervals given by:
\begin{equation}
[c+iP,~d+iP]
\end{equation}
%so we define:
%\begin{equation}
%\phi_i(x) =  \phi(x+iP)\Pi_{[c,d]}(x)
%\label{eq:rholim_period}
%\end{equation}

The contribution of the j-th term of $\rho$ to  $\phi$ int the i-th interval:

\begin{equation}
\phi_{ij}(x) = 
\int_{-\infty}^{+\infty} 
\rho^\text{loc}_j(x' - jP)\,G^\text{tr}_{i-j}(x-x') dx'
\end{equation}

where:
\begin{equation}
G^\text{tr}_l(x'') = G(x'')\,
\Pi_{[c-b+lP,~d-a+lP]}
\left(
{x''}
\right)
\end{equation}

We define a local version of $G^\text{tr}$ as

\begin{equation}
G^\text{tr, loc}_l(x) = G^\text{tr}_l(x + lP) 
=
G(x +lP)\,
\Pi_{[c-b,~d-a]}
\left(x\right)
\end{equation}

obtaining:
\begin{equation}
\phi_{ij}(x) = 
\int_{-\infty}^{+\infty} 
\rho^\text{loc}_j(x' - jP)\,G^\text{tr, loc}_{i-j}(x-x'-(i-j)P) dx'
\end{equation}

We replace $x' = x' - jP$:
\begin{equation}
\phi_{ij}(x) = 
\int_{-\infty}^{+\infty} 
\rho^\text{loc}_j(x')\,G^\text{tr, loc}_{i-j}(x-x' - iP) dx'
\end{equation}

We define a local version of $\phi$:
\begin{equation}
\phi_{ij}^\text{loc}(x) = \phi_{ij}(x+iP)
\end{equation}

obtaining:
\begin{equation}
\phi_{ij}^\text{loc}(x) = \int_{-\infty}^{+\infty} 
\rho^\text{loc}_j(x')\,G^\text{tr, loc}_{i-j}(x-x') dx'
\end{equation}

I explicit all the pies:
\begin{equation}
\phi_{ij}^\text{loc}(x) = \int_{-\infty}^{+\infty}
\Pi_{[a,b]}(x')
\Pi_{[c-b,~d-a]}(x-x')
\rho^\text{loc}_j(x')\,G^\text{tr, loc}_{i-j}(x-x') dx'
\end{equation}

Again, we want to find the region in $x$ where this is non-zero:

\begin{align}
&a<x'<b\\
&c-b< x-x'<d-a
\end{align}

from which:
\begin{align}
&c-b+x'< x<d-a+x'\\
&c-b+a< x<d-a+b
\end{align}

So we find that $\phi_{ij}^\text{loc}(x)$ is non-zero in the region:
\begin{align}
&c-L_1< x<d+L_1
\label{eq:support}
\end{align}


The total potential in the i-th interval of interest:
\begin{equation}
\phi_{i}^\text{loc}(x)
=\sum_j \phi_{ij}^\text{loc}(x) = \sum_j\int_{-\infty}^{+\infty}
\rho^\text{loc}_j(x')\,G^\text{tr, loc}_{i-j}(x-x') dx'
\end{equation}

Since all terms in the sum are zero outside the region defined by Eq.\,\ref{eq:support} also $\phi_{i}^\text{loc}(x)$ is zero outside the same interval, which is larger by $2L_1$ compared to the set of interest $[c, d]$.

We build:
\begin{equation}
\phi^\text{aux}(x)= 
\sum_i \phi_{i}^\text{loc}(x - iL_\text{aux})
\end{equation}
where:
\begin{equation}
L_\text{aux} = L_1 + L_2
\end{equation}

We replace
\begin{equation}
\phi^\text{aux}(x)= 
\sum_{i} 
 \phi_{i}^\text{loc}(x) = 
  \sum_i\sum_j
 \int_{-\infty}^{+\infty}
\rho^\text{loc}_j(x')\,G^\text{tr, loc}_{i-j}(x-x'-iL_\text{aux}) dx'
\end{equation}

We substitute $x' = x'' - jL_\text{aux}$ 
\begin{equation}
\phi^\text{aux}(x)= 
\sum_{i} 
 \phi_{i}^\text{loc}(x) = 
  \sum_i\sum_j
 \int_{-\infty}^{+\infty}
\rho^\text{loc}_j(x''-jL_\text{aux} )\,G^\text{tr, loc}_{i-j}(x-x''-(i-j)L_\text{aux}) dx''
\end{equation}

With $i = l + j$, we obtain 
 \begin{equation}
\phi^\text{aux}(x)= 
\int_{-\infty}^{+\infty}
\sum_j \rho^\text{loc}_j(x''-jL_\text{aux} )\,
\sum_l G^\text{tr, loc}_l(x-x''-lL_\text{aux}) dx''
\end{equation}

\clearpage
---------

I explicit all the pies:

\begin{equation}
\phi_{ij}(x) = 
\int_{-\infty}^{+\infty} 
\Pi_{[a, b]} (x' - jP)\,
\rho^\text{loc}_j(x' - jP)\,
\Pi_{[c-b+(i-j)P,~d-a+(i-j)P]}(x-x')
G^\text{tr}_{i-j}(x-x') dx'
\end{equation}

and use the local version of G:
\begin{equation}
\phi_{ij}(x) = 
\int_{-\infty}^{+\infty} 
\Pi_{[a, b]} (x' - jP)\,
\rho^\text{loc}_j(x' - jP)\,
\Pi_{[c-b,~d-a]}(x-x')
G^\text{tr, loc}_{i-j}(x - x' +(i-j) P) dx'
\label{eq:contrib}
\end{equation}

%We want to find the region in $x$ where this is non-zero:
%
%\begin{align}
%&a<x' - jP<b\\
%&c-b+(i-j)P< x-x'<d-a+(i-j)P
%\end{align}
%
%From which:
%
%\begin{align}
%c-b+x'-jP< x-iP<d-a+x'-jP\\
%c+iP-L_1< x<d+iP+L_1
%\end{align}

We define a local version of $\phi_{ij}$:

\begin{equation}
\phi_{ij}^\text{loc}(x) = \phi_{ij}(x+iP)
\end{equation}

Replacing in Eq.\,\ref{eq:contrib}:
\begin{equation}
\phi_{ij}^\text{loc}(x) = 
\int_{-\infty}^{+\infty} 
\Pi_{[a, b]} (x' - jP)\,
\rho^\text{loc}_j(x' - jP)\,
\Pi_{[c-b+(i-j)P,~d-a+(i-j)P]}(x+iP-x')
G^\text{tr}_{i-j}(x+iP-x') dx'
\end{equation}

We change variable $x'' = x' - iP$ ie. $x' = x'' + iP$

\begin{equation}
\phi_{ij}^\text{loc}(x) = 
\int_{-\infty}^{+\infty} 
\Pi_{[a, b]} (x'' + (i - j)P)\,
\rho^\text{loc}_j(x'' + (i - j)P)\,
\Pi_{[c-b+(i-j)P,~d-a+(i-j)P]}(x-x'')
G^\text{tr}_{i-j}(x-x'') dx''
\end{equation}


Again, we want to find the region in $x$ where this is non-zero:

\begin{align}
&a<x'' + (i-j)P<b\\
&c-b+(i-j)P< x-x''<d-a+(i-j)P
\end{align}

from which:
\begin{align}
&c-b+(i-j)P +x''< x<d-a+(i-j)P+x''\\
&c-b+a< x<d-a+b
\end{align}

So we find that $\phi_{ij}^\text{loc}(x)$ is non-zero in the region:
\begin{align}
&c-L_1< x<d+L_1
\end{align}
which is larger by $2L_1$ compared to the set interest $[c, d]$






---------------

Therefore $\phi$ int the i-th interval can be written as:
\begin{equation}
\phi_{i}(x) = 
\Pi_{[c+iP,d+iP]}\left({x}\right)
\sum_j
\int_{-\infty}^{+\infty} 
\rho_j(x' - jP)\,G_\text{tr,ij}(x-x') dx'
\end{equation}

We refine x with respect to the local period center:
\begin{equation}
\phi_{\text{loc},~i}(x) = \phi_{i}(x + iP)=c
\Pi_{[c,d]}\left({x}\right)
\sum_j
\int_{-\infty}^{+\infty} 
\rho_j(x' - jP)\,G_\text{tr,ij}(x-x'+iP) dx'
\end{equation}

We build an auxiliary potential function as 

\begin{equation}
\phi_\text{aux}(x) = \sum 
\end{equation}



\subsection{FFT convolution with gaps - 1D case}

The potential can be written as the convolution of a Green function with the charge distribution:
\begin{equation}
\phi(x) = \int_{-\infty}^{+\infty} \rho(x')\,G(x-x') dx'
\label{eq:conv_period}
\end{equation}

We assume that the source has the form
\begin{equation}
\rho(x) = \rho(x) \sum_i \Pi_{[a+iP,~b+iP]}\left(x\right)
\label{eq:rholim_period}
\end{equation}

We are interested in the electric potential in regions with a similar periodicity:
\begin{equation}
\phi_{cd}(x) = \phi(x)  \sum_i \Pi_{[c+iP,~d+iP]}\left(x\right)
\label{eq:philim_period}
\end{equation}

We replace Eq.\,\eqref{eq:rholim_period} and Eq.\,\eqref{eq:philim_period} into Eq.\eqref{eq:conv_period}, obtaining:
\begin{equation}
\phi_{cd}(x) =  \sum_{ij} \Pi_{[c+iP,~d+iP]}\left( x\right)
\int_{-\infty}^{+\infty} 
\Pi_{[a+jP,~b+jP]}\left(x'\right)
\rho(x')\,G(x-x') dx'
\end{equation}
We apply the change of variable $x'' = x - x'$:
\begin{equation}
\phi_{cd}(x) = 
\sum_{ij}
\int_{-\infty}^{+\infty} 
\Pi_{[c+iP,~d+iP]}\left({x}\right)
\Pi_{[a+jP,~b+jP]}\left({x-x''}\right)
\rho(x-x'')\,G(x'') \,dx''
\label{eq:conv1}
\end{equation}

The integrand vanishes outside the set of the $(x, x'')$ defined by the two window functions:
\begin{equation}
\begin{cases}
c+iP < x <d+iP\\
a+jP < (x-x'') < b+jP
\end{cases}
\end{equation}

We flip the signs in the second equation, obtaining:
\begin{equation}
\begin{cases}
c +iP < x < d+iP\\
-b -jP < (x''-x) <-a-jP
\end{cases}
\end{equation}

Combining the two equations we obtain:
\begin{equation}
c-b +(i-j)P<-b -jP + x < x'' <-a -jP+x<d-a + (i-j)P
\end{equation}

i.e. the integrand is not zero for:
\begin{equation}
c-b +lP < x'' <d-a + lP
\end{equation}
Therefore in Eq.\,\eqref{eq:conv1} we can replace $G(x'')$ with its gated version:
\begin{equation}
G_\text{gated}(x'') = G(x'')\,
\sum_l \Pi_{[c-b+lP,~d-a+lP]}
\left(
{x''}
\right)
\end{equation}

\clearpage






--------------------
\section{Old stuff}


We can approximate the integrals in Eqs.\,\eqref{eq:rhok} and\,\eqref{eq:Gk} as:
\begin{align}
\tilde{\rho}_k = \frac{1}{M}\sum_{n=0}^{M-1} \rho_{Rn}\, e^{-j2\pi  \frac{kn}{M}}  
= \frac{1}{M} \hat{\rho}_k
\label{eq:rhokfft}\\
\tilde{G}_k = \frac{1}{M}\sum_{n=0}^{M-1} G_{Rn}\, e^{-j2\pi  \frac{kn}{M}} 
= \frac{1}{M} \hat{G}_k\label{eq:Gkfft}
\end{align}




We recognize the Discrete Fourier Transforms:
\begin{align}
\hat{\rho}_k = \text{DFT}_M\left\{ \rho_{Rn}\right\}\\
\hat{G}_k = \text{DFT}_M\left\{ G_{Rn}\right\}
\end{align}



Using Eq.\,\eqref{eq:phifour} we can obtain a sampled version of $\phi(x)$:
\begin{equation}
\phi_{2LR}(x_n) = 
\sum_{n=0}^{M-1}  
\tilde{\phi}_k\, e^{j2\pi \frac{kn}{M}}
\label{eq:phifft}
\end{equation}
where we have assumed that $\phi(x)$ is sufficiently smooth to allow truncating the sum.


Using Eqs.\,\eqref{eq:freqconv}, \eqref{eq:rhokfft} and\,\eqref{eq:Gkfft}  we obtain:
\begin{equation}
\phi_{2LR}(x_n) = 
2L \sum_{n=0}^{M-1}  
\tilde{G}_k \, \tilde{\rho}_k\, e^{j2\pi \frac{kn}{M}} 
= 
\frac{2L}{M^2}
\sum_{n=0}^{M-1}  
\hat{G}_k \, \hat{\rho}_k\, e^{j2\pi \frac{kn}{M}} 
\label{eq:phifftsimpl}
\end{equation}

This can be rewritten as:
\begin{equation}
\phi_{2LR}(x_n) = 
\frac{1}{M}
\sum_{n=0}^{M-1}  
(h_x\hat{G}_k) \, \hat{\rho}_k\, e^{j2\pi \frac{kn}{M}} 
=\text{DFT}_M^{-1}\left\{\hat\phi_k
\right\}
\label{eq:invfft}
\end{equation}
where 
\begin{equation}
\hat{\phi}_k =h_x\hat{G}_k \, \hat{\rho}_k
\label{eq:phiknint}
\end{equation}
We call ``Integrated Green Function'' the quantity:
\begin{equation}
G^\text{int}_{2LR}(x_n) = h_x G_{2LR}(x_n)
\end{equation}
we introduce the corresponding Fourier transform:
\begin{equation}
\hat{G}_k^\text{int} = \text{DFT}_M\left\{ G_{2LR}^\text{int}(x_n)\right\}
\end{equation}
Eq.\,\eqref{eq:phiknint} can be rewritten as:
\begin{equation}
\boxed{
\hat{\phi}_k =\hat{G}_k^\text{int} \, \hat{\rho}_k}
\end{equation}

In summary the potential at the grid nodes can be computed as follows:
\begin{enumerate}
\item We compute the Integrated Green function at the grid points in the range $[0, L]$:
\begin{equation}
G_{2LR}^\text{int}(x_n) = \int_{x_n-\frac{h_x}{2}}^{x_n+\frac{h_x}{2}} G(x) dx
\end{equation}
\item We extend to the interval $[L, 2L]$ using the fact that in this interval:
\begin{equation}
G^\text{int}_{2LR}(x_n) = G^\text{int}_{2LR}(x_n-2L) =  G^\text{int}_{2LR}(2L-x_n)
\end{equation}
where the first equality comes from the periodicity of $G^\text{int}_{2LR}(x)$ and the second from the fact that $G(x)$ is an even function (i.e. $G(x) = G(-x)$).
Note that for $x_n \in [L, 2L]$ we have that $2L-x_n \in [0, L]$ so we can reuse the values computed at the previous step.
\item We transform it:
\begin{equation}
\hat{G}^\text{int}_k = \text{DFT}_{2N}\left\{ G_{2LR}(x_n)\right\}
\end{equation}
\item We assume that we are given $\rho(x_n)$ in the interval $[0, L]$. From this we can obtain $\rho_{2LR}(x_n)$ over the interval $[0, 2L]$ simply extending the sequence with zeros (see Eq.\,\eqref{eq:zeros}).
\item We transform it:
\begin{equation}
\hat{\rho}_k = \text{DFT}_{2N}\left\{ \rho_{2LR}(x_n)\right\}
\end{equation}
\item We compute the potential in the transformed domain:
\begin{equation}
\hat{\phi}_k = \hat{G}^\text{int}_k \hat{\rho}_k \quad \text{for } k\in [0, 2N]
\end{equation}
\item We inverse-transform:
\begin{equation}
\phi_{2LR}(x_n)  = \text{DFT}_{2N}^{-1}\left\{\hat{\phi}_k\right\}
\end{equation}
which provides the physical potential in the range $[0, L]$:
\begin{equation}
\phi(x_n)  = \phi_{2LR}(x_n)  \quad \text{for } x_n\in [0, L]
\end{equation}
\end{enumerate}


\subsection{Extension to multiple dimensionss}

The procedure described above can be extended to multiple dimensions by applying the same reasoning for all coordinates. 
This gives the following procedure:
\begin{enumerate}
\item We compute the Integrated Green function at the grid points in the volume $[0, L_x]\times[0, L_y]\times[0, L_z]$:
\begin{equation}
G_{2LR}^\text{int}(x_{n_x}, y_{n_y}, z_{n_z}) = 
\int_{x_{n_x}-\frac{h_x}{2}}^{x_{n_x}+\frac{h_x}{2}} dx
\int_{y_{n_y}-\frac{h_y}{2}}^{y_{n_y}+\frac{h_y}{2}} dy
\int_{z_{n_z}-\frac{h_z}{2}}^{z_{n_z}+\frac{h_z}{2}} dz\,
G(x,y,z)
\end{equation}
\item We extend to the region $[0, 2L_x]\times[0, 2L_y]\times[0, 2L_z]$ using the fact that:
\begin{multline}
G^\text{int}_{2LR}(x_n, y_n, z_n) = G^\text{int}_{2LR}(x_n-2L_x, y_n, z_n) =  G^\text{int}_{2LR}(2L_x-x_n, y_n, z_n)\\
\text{for } x_n \in [L_x, 2L_x], y_n \in [0, 2L_y], z_n \in [0, 2L_z]
\end{multline}
\begin{multline}
G^\text{int}_{2LR}(x_n, y_n, z_n) = G^\text{int}_{2LR}(x_n, y_n-2L_y, z_n) =  G^\text{int}_{2LR}(x_n, 2L_y-y_n,  z_n)\\
\text{for } y_n \in [L_y, 2L_y], x_n \in [0, 2L_x], z_n \in [0, 2L_z]
\end{multline}
\begin{multline}
G^\text{int}_{2LR}(x_n, y_n, z_n) = G^\text{int}_{2LR}(x_n, y_n, z_n-2L_z) =  G^\text{int}_{2LR}(x_n, y_n,  2L_z-z_n)\\
\text{for } z_n \in [L_z, 2L_z], x_n \in [0, 2L_x], y_n \in [0, 2L_y]
\end{multline}
This allows reusing the values computed at the previous step.
\item We transform it:
\begin{equation}
\hat{G}^\text{int}_{k_x k_y k_z} = 
\text{DFT}_{2N_x 2N_y 2N_z}\left\{ G_{2LR}(x_n, y_n, z_n)\right\}
\end{equation}
\item We assume that we are given $\rho(x_n, y_n, z_n)$ in the region $[0, L_x]\times[0, L_y]\times[0, L_z]$. From this we can obtain $\rho_{2LR}(x_n)$ over the region $[0, 2L_x]\times[0, 2L_y]\times[0, 2L_z]$ simply extending the matrix with zeros (see Eq.\,\eqref{eq:zeros}).
\item We transform it:
\begin{equation}
\hat{\rho}^\text{int}_{k_x k_y k_z} = 
\text{DFT}_{2N_x 2N_y 2N_z}\left\{ \rho_{2LR}(x_n, y_n, z_n)\right\}
\end{equation}
\item We compute the potential in the transformed domain:
\begin{equation}
\hat{\phi}_{k_x k_y k_z} = \hat{G}^\text{int}_{k_x k_y k_z} \, \hat{\rho}_{k_x k_y k_z} \quad \text{for } k_{x/y/z}\in [0, 2N_{x/y/z}]
\end{equation}
\item We inverse-transform:
\begin{equation}
\phi_{2LR}(x_n, y_n, z_n)  = \text{DFT}_{2N_x 2N_y 2N_z}^{-1}
\left\{\hat{\phi}_{k_x k_y k_z}\right\}
\end{equation}
which provides the physical potential in the region $[0, L_x]\times[0, L_y]\times[0, L_z]$:
\begin{multline}
\phi(x_n, y_n, z_n) = \phi_{2LR}(x_n, y_n, z_n)  
\text{ for } (x_n, y_n, z_n) \in [0, L_x]\times[0, L_y]\times[0, L_z]
\end{multline}
\end{enumerate}

 
\subsection{Green functions for 2D and 3D Poisson problems}

\subsubsection{3D Poisson problem, free space boundary conditions}

For the equation:
\begin{equation}
\nabla^2 \phi(x,y,z) = -\frac{1}{\varepsilon_0} \rho(x,y,z)
\end{equation}
where:
\begin{equation}
\nabla = \left(\frac{\partial}{\partial x}, 
                      \frac{\partial}{\partial y},
                      \frac{\partial}{\partial z} \right)
\end{equation}
the solution can be written as 
\begin{equation}
\phi(x, y, z) = \iiint_{-\infty}^{+\infty} \rho(x', y', z')
   \,G(x-x', y-y', z-z')\,dx'\,dy'\,dz'
\end{equation}
where:
\begin{equation}
G(x, y, z) = \frac{1}{4\pi\varepsilon_0}\frac{1}{
\sqrt{x^2 +y^2 +z^2}
}
\end{equation}

The corresponding integrated Green function can be written as:
\begin{align}
G_{2LR}^\text{int}(x_{n_x}, y_{n_y}, z_{n_z}) =& 
\int_{x_{n_x}-\frac{h_x}{2}}^{x_{n_x}+\frac{h_x}{2}} dx
\int_{y_{n_y}-\frac{h_y}{2}}^{y_{n_y}+\frac{h_y}{2}} dy
\int_{z_{n_z}-\frac{h_z}{2}}^{x_{n_z}+\frac{h_z}{2}} dz\,
G(x,y,z)\\
= &+F\left(x_{n_x}+\frac{h_x}{2}, y_{n_x}+\frac{h_y}{2}, z_{n_x}+\frac{h_z}{2}\right) \\
    &- F\left(x_{n_x}+\frac{h_x}{2}, y_{n_x}+\frac{h_y}{2}, z_{n_x}-\frac{h_z}{2}\right)\\
    &- F\left(x_{n_x}+\frac{h_x}{2}, y_{n_x}-\frac{h_y}{2}, z_{n_x}+\frac{h_z}{2}\right)\\ 
    &+ F\left(x_{n_x}+\frac{h_x}{2}, y_{n_x}-\frac{h_y}{2}, z_{n_x}-\frac{h_z}{2}\right)\\
    &-F\left(x_{n_x}-\frac{h_x}{2}, y_{n_x}+\frac{h_y}{2}, z_{n_x}+\frac{h_z}{2}\right) \\
    &+ F\left(x_{n_x}-\frac{h_x}{2}, y_{n_x}+\frac{h_y}{2}, z_{n_x}-\frac{h_z}{2}\right)\\
    &+ F\left(x_{n_x}-\frac{h_x}{2}, y_{n_x}-\frac{h_y}{2}, z_{n_x}+\frac{h_z}{2}\right)\\ 
    & - F\left(x_{n_x}-\frac{h_x}{2}, y_{n_x}-\frac{h_y}{2}, z_{n_x}-\frac{h_z}{2}\right)
\end{align}
where $F(x,y,z)$ is a primitive of $G(x,y,z)$, which can be obtained as:
\begin{equation}
F(x,y,z) = 
\int_{x_0}^{x} dx
\int_{y_0}^{y} dy
\int_{z_0}^{x} dz\,
G(x,y,z)
\end{equation}
with $(x_0, y_0, z_0)$ being an arbitrary starting point.

An expression for $F(x,y,z)$ is the following
\begin{align}
F(x,y,z) =&\frac{1}{4\pi\varepsilon_0}\iiint \frac{1}{\sqrt{x^{2}+y^{2}+z^{2}}} d x d y d z\\ 
= \frac{1}{4\pi \varepsilon_0}&\left[-\frac{z^{2}}{2} \arctan \left(\frac{x y}{z \sqrt{x^{2}+y^{2}+z^{2}}}\right)\right.
-\frac{y^{2}}{2} \arctan \left(\frac{x z}{y \sqrt{x^{2}+y^{2}+z^{2}}}\right)\\
&-\frac{x^{2}}{2} \arctan \left(\frac{y z}{x \sqrt{x^{2}+y^{2}+z^{2}}}\right) 
+y z \ln \left(x+\sqrt{x^{2}+y^{2}+z^{2}}\right)\\
&\left. +x z \ln \left(y+\sqrt{x^{2}+y^{2}+z^{2}}\right)
+x y \ln \left(z+\sqrt{x^{2}+y^{2}+z^{2}}\right)\right]
\end{align}

Note that we need to choose the first cell center to be in (0,0,0) for evaluation of the integrated Green function. Therefore the cell edges have non zero coordinates and the denominators in the formula will always be non-vanishing.

\subsubsection{2D Poisson problem, free space boundary conditions}

For the equation:
\begin{equation}
\nabla_\perp^2 \phi(x,y) = -\frac{1}{\varepsilon_0} \rho(x,y)
\end{equation}
where:
\begin{equation}
\nabla = \left(\frac{\partial}{\partial x}, 
                      \frac{\partial}{\partial y} \right)
\end{equation}
the solution can be written as 
\begin{equation}
\phi(x, y) = \iiint_{-\infty}^{+\infty} \rho(x', y')
   \,G(x-x', y-y')\,dx'\,dy'
\end{equation}
where:
\begin{equation}
G(x, y) = -\frac{1}{4\pi\varepsilon_0} \log\left( \frac{x^2 + y^2}{r_0^2}\right)
\end{equation}
where $r_0$ is arbitrary constant which has no effect on the evaluated fields (changes the potential by an additive constant). 

The corresponding integrated Green function can be written as:
\begin{align}
G_{2LR}^\text{int}(x_{n_x}, y_{n_y}) =& 
\int_{x_{n_x}-\frac{h_x}{2}}^{x_{n_x}+\frac{h_x}{2}} dx
\int_{y_{n_y}-\frac{h_y}{2}}^{y_{n_y}+\frac{h_y}{2}} dy\,
G(x,y,z)\\
= &+F\left(x_{n_x}+\frac{h_x}{2}, y_{n_x}+\frac{h_y}{2}\right)\\
    &-F\left(x_{n_x}+\frac{h_x}{2}, y_{n_x}-\frac{h_y}{2}\right)\\
    &-F\left(x_{n_x}-\frac{h_x}{2}, y_{n_x}+\frac{h_y}{2}\right)\\ 
    &+F\left(x_{n_x}-\frac{h_x}{2}, y_{n_x}-\frac{h_y}{2}\right)\\
\end{align}
where $F(x,y)$ is a primitive of $G(x,y)$, which can be obtained as:
\begin{equation}
F(x,y) = 
\int_{x_0}^{x} dx
\int_{y_0}^{y} dy\,
G(x,y)
\end{equation}
where $(x_0, y_0)$ is an arbitrary starting point.

An expression for $F(x,y)$ is the following (where we have chosen $r_0=1$):
\begin{align}
F(x,y) &=-\frac{1}{4\pi\varepsilon_0}\iint \ln \left(x^{2}+y^{2}\right) dx/,dy\\
&=\frac{1}{4\pi\varepsilon_0}\left[3 x y-x^{2} \arctan (y / x)-y^{2} \arctan (x / y)-x y \ln \left(x^{2}+y^{2}\right)\right]
\end{align}

Note that we need to choose the first cell center to be in (0,0) for evaluation of the integrated Green function. Therefore the cell edges have non zero coordinates and the denominators in the formula will always be non-vanishing.